#!/bin/bash

# ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±ã‚’åé›†
declare -a process_list

# ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆpgrep -xã§æ­£ç¢ºã«"claude"ã®ã¿ï¼‰
index=0
for pid in $(pgrep -x claude | sort -u); do
    # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
    dir=$(lsof -p $pid 2>&1 | grep -v "ERR:" | grep cwd | awk '{print $NF}' | head -1)
    [ -z "$dir" ] || [ "$dir" = "/" ] && continue
    
    # TTYæƒ…å ±ã‚’å–å¾—
    tty=$(ps -p $pid -o tty= 2>/dev/null | tr -d ' ')
    [ -z "$tty" ] || [ "$tty" = "??" ] && continue
    
    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
    project=$(basename "$dir")
    
    # CPUä½¿ç”¨ç‡ã‚’å–å¾—ã—ã¦çŠ¶æ…‹ã‚’åˆ¤å®š
    cpu=$(ps -p $pid -o %cpu= 2>/dev/null | tr -d ' ')
    cpu_int=$(echo "$cpu" | cut -d'.' -f1)
    [ -z "$cpu_int" ] && cpu_int=0
    
    # çŠ¶æ…‹ã«å¿œã˜ãŸçµµæ–‡å­—ã‚’è¿½åŠ 
    if [ "$cpu_int" -gt 1 ]; then
        status_emoji="ğŸ”µ "
    else
        status_emoji="ğŸ”´ "
    fi
    
    # Gitæƒ…å ±ã‚’å–å¾—
    git_info=""
    if [ -d "$dir/.git" ]; then
        branch=$(cd "$dir" && git branch --show-current 2>/dev/null)
        changes=$(cd "$dir" && git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
        if [ -n "$branch" ]; then
            git_info=" [$branch"
            [ "$changes" != "0" ] && [ -n "$changes" ] && git_info="${git_info} +$changes"
            git_info="${git_info}]"
        fi
    fi
    
    # é…åˆ—ã«ä¿å­˜
    process_list[$index]="${pid}|${tty}|${status_emoji}${project}${git_info}|${dir}"
    ((index++))
done

# ãƒ—ãƒ­ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
if [ ${#process_list[@]} -eq 0 ]; then
    echo "No claude processes found."
    exit 1
fi

# fzfç”¨ã®è¡¨ç¤ºãƒªã‚¹ãƒˆã‚’ä½œæˆ
display_list=""
for i in "${!process_list[@]}"; do
    IFS='|' read -r pid tty project dir <<< "${process_list[$i]}"
    # ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
    relative_dir="${dir/#$HOME/~}"
    display_list="${display_list}$(printf "%-30s %s\n" "$project" "$relative_dir")"
    [ $i -lt $((${#process_list[@]} - 1)) ] && display_list="${display_list}\n"
done

# ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
temp_file=$(mktemp)
for item in "${process_list[@]}"; do
    echo "$item" >> "$temp_file"
done

# fzfã§é¸æŠ
selected=$(echo -e "$display_list" | fzf --ansi --no-sort --reverse \
    --header='Select a claude process to switch to:' 2>/dev/null)

# fzfã®çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ130 = Ctrl+C, 1 = Escï¼‰
fzf_exit_code=$?
if [ $fzf_exit_code -eq 130 ] || [ $fzf_exit_code -eq 1 ]; then
    rm -f "$temp_file"
    exit 0
fi

# é¸æŠã•ã‚Œãªã‹ã£ãŸå ´åˆ
if [ -z "$selected" ]; then
    rm -f "$temp_file"
    exit 0
fi

# é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—ï¼ˆGitæƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰
selected_project=$(echo "$selected" | awk '{print $1}')

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è©²å½“ã™ã‚‹è¡Œã‚’å–å¾—
selected_line=$(grep -F "|$selected_project" "$temp_file" | head -1)

# é¸æŠã•ã‚ŒãŸæƒ…å ±ã‚’è§£æ
if [ -z "$selected_line" ]; then
    # Gitæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢
    selected_line=$(grep -F "$selected_project" "$temp_file" | head -1)
fi

# TTYã‚’å–å¾—
IFS='|' read -r pid tty project dir <<< "$selected_line"

# TTYã‹ã‚‰tmuxã®ãƒšã‚¤ãƒ³IDã‚’å–å¾—
# TTYãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: pts/N
pts_num=$(echo "$tty" | sed 's/pts\///')

# tmuxã®å…¨ãƒšã‚¤ãƒ³ã‚’æ¤œç´¢ã—ã¦TTYãŒä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’æ¢ã™
pane_id=""
for pane in $(tmux list-panes -a -F "#{pane_id}:#{pane_tty}"); do
    pane_tty=$(echo "$pane" | cut -d':' -f2)
    pane_tty_num=$(basename "$pane_tty" 2>/dev/null)
    
    if [ "$pane_tty_num" = "$pts_num" ]; then
        pane_id=$(echo "$pane" | cut -d':' -f1)
        break
    fi
done

# ãƒšã‚¤ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
if [ -z "$pane_id" ]; then
    echo "Could not find tmux pane for TTY: $tty"
    rm -f "$temp_file"
    exit 1
fi

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
rm -f "$temp_file"

# ãƒšã‚¤ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ
tmux switch-client -t "$pane_id" 2>/dev/null || tmux select-pane -t "$pane_id"